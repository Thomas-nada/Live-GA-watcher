<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Cardano Governance Proposals (Multi-Network)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Style for the select dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239CA3AF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 0.65rem;
        }
        .modal-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .modal-scrollbar::-webkit-scrollbar-track {
            background: #374151; /* bg-gray-700 */
        }
        .modal-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280; /* bg-gray-500 */
            border-radius: 3px;
        }
        .threshold-line {
            position: absolute;
            top: -2px;
            bottom: -2px;
            width: 2px;
            transform: translateX(-50%);
            z-index: 10;
        }
        select:disabled, button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .ai-summary-content h1, .ai-summary-content h2, .ai-summary-content h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .ai-summary-content h1 { font-size: 1.25rem; }
        .ai-summary-content h2 { font-size: 1.1rem; }
        .ai-summary-content ul { list-style-type: disc; margin-left: 1.5rem; }
        .ai-summary-content ol { list-style-type: decimal; margin-left: 1.5rem; }
        .ai-summary-content a { color: #67e8f9; text-decoration: underline; }
        .ai-summary-content p { margin-bottom: 0.5rem; }

        .gemini-button {
            background: linear-gradient(to right, #4f46e5, #9333ea);
        }
        .nav-button[aria-selected="true"] {
            background-color: #0891b2; /* cyan-600 */
            color: white;
        }
         .nav-button[aria-selected="false"] {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header Section -->
        <header class="text-center mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">Cardano Governance Dashboard</h1>
            <p class="text-gray-400">Live data for <span id="network-name" class="font-bold text-cyan-400">Mainnet</span></p>
        </header>

        <!-- Navigation -->
        <nav class="flex flex-wrap justify-center mb-8 bg-gray-800 rounded-lg p-1">
            <button id="nav-proposals" class="nav-button font-semibold py-2 px-6 rounded-md transition-colors" aria-selected="true">Proposals</button>
            <button id="nav-drep-directory" class="nav-button font-semibold py-2 px-6 rounded-md transition-colors" aria-selected="false">DRep Directory</button>
        </nav>

        <!-- Proposals Page -->
        <div id="proposals-page">
            <!-- Filter and Sort Controls -->
            <div id="controls" class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="network-select" class="bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <option value="mainnet">Network: Mainnet</option>
                    <option value="preprod">Network: Preprod</option>
                    <option value="preview">Network: Preview</option>
                </select>
                <select id="type-filter" class="bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <option value="all">Filter by Type: All</option>
                    <option value="ParameterChange">Parameter Change</option>
                    <option value="HardForkInitiation">Hard-Fork Initiation</option>
                    <option value="TreasuryWithdrawals">Treasury Withdrawals</option>
                    <option value="MotionOfNoConfidence">Motion of No-Confidence</option>
                    <option value="NewCommittee">New Committee</option>
                    <option value="UpdateToConstitution">Update Constitution</option>
                    <option value="InfoAction">Info Action</option>
                </select>
                <input type="text" id="search-filter" placeholder="Filter by title..." class="sm:col-span-2 lg:col-span-1 flex-grow bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                <select id="sort-select" class="bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <option value="drep-yes-pct-desc">Sort by: Highest DRep Yes %</option>
                    <option value="drep-yes-pct-asc">Sort by: Lowest DRep Yes %</option>
                </select>
            </div>
            <main id="proposals-container"><!-- Proposals will be injected here --></main>
        </div>

        <!-- DRep Directory Page -->
        <div id="drep-directory-page" class="hidden">
            <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                 <input type="text" id="drep-search-filter" placeholder="Search by DRep ID..." class="w-full bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                 <select id="drep-status-filter" class="bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <option value="all">Filter by Status: All</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="retired">Retired</option>
                </select>
            </div>
            <main id="drep-list-container"><!-- DRep list will be injected here --></main>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm space-y-2">
            <p>Data sourced from the <a href="https://koios.rest/" target="_blank" class="text-blue-400 hover:underline">Koios REST API</a>.</p>
             <p>UI inspired by a <a href="https://github.com/IntersectMBO/governance-scripts/blob/main/scripts/query-live-actions.sh" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">script</a> by <a href="https://github.com/Ryun1" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Ryun1</a>.</p>
            <p>Last updated: <span id="last-updated"></span></p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="votes-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 id="modal-title" class="text-xl font-bold text-white">Votes</h3>
                    <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="rationale-filter" class="bg-gray-700 border border-gray-600 rounded focus:ring-cyan-500 h-4 w-4 text-cyan-600">
                    <label for="rationale-filter" class="text-sm text-gray-300">Show only votes with rationale</label>
                </div>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto modal-scrollbar"><!-- Vote content here --></div>
        </div>
    </div>

    <div id="ai-summary-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="ai-modal-title" class="text-xl font-bold text-white">âœ¨ AI-Powered Summary</h3>
                <button id="ai-modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="ai-modal-content" class="p-6 overflow-y-auto modal-scrollbar ai-summary-content"><!-- AI Summary here --></div>
        </div>
    </div>

    <div id="rationale-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="rationale-modal-title" class="text-xl font-bold text-white">Vote Rationale</h3>
                <button id="rationale-modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="rationale-modal-content" class="p-6 overflow-y-auto modal-scrollbar ai-summary-content"><!-- Rationale content will be loaded here --></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const proposalsContainer = document.getElementById('proposals-container');
            const drepListContainer = document.getElementById('drep-list-container');
            const lastUpdatedElement = document.getElementById('last-updated');
            const networkSelect = document.getElementById('network-select');
            const networkNameSpan = document.getElementById('network-name');

            // Page containers and nav
            const proposalsPage = document.getElementById('proposals-page');
            const drepDirectoryPage = document.getElementById('drep-directory-page');
            const navProposals = document.getElementById('nav-proposals');
            const navDRepDirectory = document.getElementById('nav-drep-directory');

            // Proposal page controls
            const searchInput = document.getElementById('search-filter');
            const sortSelect = document.getElementById('sort-select');
            const typeFilterSelect = document.getElementById('type-filter');

            // DRep page controls
            const drepSearchInput = document.getElementById('drep-search-filter');
            const drepStatusFilter = document.getElementById('drep-status-filter');

            // Modals
            const votesModal = document.getElementById('votes-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const rationaleFilterCheckbox = document.getElementById('rationale-filter');
            const aiSummaryModal = document.getElementById('ai-summary-modal');
            const aiModalTitle = document.getElementById('ai-modal-title');
            const aiModalContent = document.getElementById('ai-modal-content');
            const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
            const rationaleModal = document.getElementById('rationale-modal');
            const rationaleModalTitle = document.getElementById('rationale-modal-title');
            const rationaleModalContent = document.getElementById('rationale-modal-content');
            const rationaleModalCloseBtn = document.getElementById('rationale-modal-close-btn');

            // --- State and Configuration ---
            let allFetchedProposals = [];
            let allFetchedDReps = [];
            let currentNetwork = 'mainnet';
            let currentModalVotes = [];
            let currentModalVoterType = ''; // 'DRep', 'DRepHistory'
            let voterVoteHistory = [];
            let dataCache = { proposals: false, dreps: false };
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyNKJ4hBBc0TA3TbWqXW0w3p0uOQhJ9zJ5WAi8sEHylf_scxqyUvHw6_DY0hizGl032/exec';

            const markdownConverter = new showdown.Converter({ simplifiedAutoLink: true, openLinksInNewWindow: true });
            const networkConfigs = {
                mainnet: { apiBase: "https://api.koios.rest/api/v1", govTools: "https://gov.tools", cExplorer: "https://cexplorer.io", name: "Mainnet" },
                preprod: { apiBase: "https://preprod.koios.rest/api/v1", govTools: "https://preprod.gov.tools", cExplorer: "https://preprod.cexplorer.io", name: "Pre-production" },
                preview: { apiBase: "https://preview.koios.rest/api/v1", govTools: "https://preview.gov.tools", cExplorer: "https://preview.cexplorer.io", name: "Preview" }
            };
            const typeStyles = {
                'MotionOfNoConfidence': { text: 'Motion of No-Confidence', classes: 'bg-red-800 text-red-100 border-red-600' },
                'NewCommittee': { text: 'New Committee', classes: 'bg-blue-800 text-blue-100 border-blue-600' },
                'UpdateToConstitution': { text: 'Update Constitution', classes: 'bg-indigo-800 text-indigo-100 border-indigo-600' },
                'HardForkInitiation': { text: 'Hard Fork', classes: 'bg-amber-800 text-amber-100 border-amber-600' },
                'TreasuryWithdrawals': { text: 'Treasury Withdrawal', classes: 'bg-green-800 text-green-100 border-green-600' },
                'ParameterChange': { text: 'Parameter Change', classes: 'bg-teal-800 text-teal-100 border-teal-600'},
                'InfoAction': { text: 'Info Action', classes: 'bg-gray-700 text-gray-200 border-gray-500' },
                'Default': { text: 'Unknown Type', classes: 'bg-gray-700 text-gray-200 border-gray-500' }
            };
            const jokes = ["Waking up the Koios API...", "Consulting the Ouroboros...", "Syncing with the epoch boundary...", "Delegating our fetch request..."];
            const ANCHOR_EPOCH = 492, ANCHOR_EPOCH_END_MS = new Date('2024-06-23T21:45:00Z').getTime(), EPOCH_DURATION_MS = 5 * 24 * 60 * 60 * 1000;

            // --- Helper & Utility Functions ---
            const getExpirationTimestamp = (e) => e ? ANCHOR_EPOCH_END_MS + ((e - ANCHOR_EPOCH) * EPOCH_DURATION_MS) : null;
            const pascalToTitleCase = (s) => s ? s.replace(/([A-Z])/g, ' $1').trim() : '';
            const proxyUrl = (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`;
            const showLoading = (container) => {
                const joke = jokes[Math.floor(Math.random() * jokes.length)];
                container.innerHTML = `<div class="flex flex-col items-center justify-center text-center p-10"><svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-lg font-medium">${joke}</p><p class="text-gray-500">Fetching data for ${networkConfigs[currentNetwork].name}.</p></div>`;
            };
            const displayError = (container, message) => {
                container.innerHTML = `<div class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg"><strong class="font-bold">Error:</strong> <span>${message}</span></div>`;
            };
            const setControlsDisabled = (disabled) => [networkSelect, searchInput, sortSelect, typeFilterSelect, drepSearchInput, drepStatusFilter].forEach(el => el.disabled = disabled);

            // --- Page Navigation ---
            function showPage(page) {
                proposalsPage.classList.toggle('hidden', page !== 'proposals');
                drepDirectoryPage.classList.toggle('hidden', page !== 'dreps');
                
                navProposals.setAttribute('aria-selected', page === 'proposals');
                navDRepDirectory.setAttribute('aria-selected', page === 'dreps');

                if (page === 'proposals' && !dataCache.proposals) fetchAndDisplayProposals();
                if (page === 'dreps' && !dataCache.dreps) fetchAndDisplayDReps();
            }

            // --- Proposal Page Logic ---
            const getThresholds = (t) => ({'TreasuryWithdrawals':{drep:0.67,spo:null},'HardForkInitiation':{drep:0.6,spo:0.51},'MotionOfNoConfidence':{drep:0.67,spo:0.51},'NewCommittee':{drep:0.67,spo:0.51},'UpdateToConstitution':{drep:0.75,spo:null},'ParameterChange':{drep:0.67,spo:0.51},'InfoAction':{drep:null,spo:null}})[t]||{drep:null,spo:null};
            
            function renderProposals(proposals) {
                proposalsContainer.innerHTML = '';
                if (proposals.length === 0) {
                    proposalsContainer.innerHTML = `<div class="text-center p-10 bg-gray-800 rounded-lg col-span-full"><p class="text-lg">No proposals match filters.</p></div>`;
                    return;
                }
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                proposals.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col transition-all duration-300 hover:shadow-cyan-500/20 hover:ring-1 hover:ring-cyan-800';
                    const style = typeStyles[p.type] || { ...typeStyles['Default'], text: pascalToTitleCase(p.type) };
                    const thresholds = getThresholds(p.type);

                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="mb-4"><span class="text-xs font-bold px-3 py-1 rounded-full border ${style.classes}">${style.text.toUpperCase()}</span></div>
                            <h2 class="text-lg font-bold text-white mb-1">${p.title}</h2>
                            <a href="${networkConfigs[currentNetwork].govTools}/governance_actions/${p.proposal_id}" target="_blank" rel="noopener noreferrer" class="block text-xs text-cyan-400 hover:underline mb-4 break-all font-mono">ID: ${p.proposal_id}</a>
                            <div>
                                <div class="flex justify-between items-end mb-1"><span class="text-sm font-medium text-green-400">DRep "Yes"</span><span class="text-xl font-bold text-green-300">${p.drep_yes_pct.toFixed(2)}%</span></div>
                                <div class="relative w-full bg-gray-700 rounded-full h-3"><div class="bg-gradient-to-r from-green-500 to-emerald-400 h-3 rounded-full" style="width: ${p.drep_yes_pct}%"></div>${thresholds.drep ? `<div class="threshold-line bg-yellow-300" style="left: ${thresholds.drep*100}%" title="Threshold"></div>` : ''}</div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center text-sm mt-3">
                                <div><p class="text-gray-400">Yes</p><p class="font-semibold">${p.drep_yes_votes_cast.toLocaleString()}</p></div>
                                <div><p class="text-gray-400">No</p><p class="font-semibold">${p.drep_no_votes_cast.toLocaleString()}</p></div>
                                <div><p class="text-gray-400">Abstain</p><p class="font-semibold">${p.drep_abstain_votes_cast.toLocaleString()}</p></div>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-700/50 flex flex-col gap-3">
                            <button class="summarize-btn w-full gemini-button text-white font-bold py-2 px-4 rounded-lg" data-proposal-id="${p.proposal_id}">âœ¨ Summarize with AI</button>
                            <button class="view-votes-btn w-full bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg" data-proposal-id="${p.proposal_id}" data-voter-type="DRep">View DRep Votes</button>
                        </div>`;
                    grid.appendChild(card);
                });
                proposalsContainer.appendChild(grid);
            }

            function applyProposalFilters() {
                const filterText = searchInput.value.toLowerCase();
                const typeFilter = typeFilterSelect.value;
                const sortValue = sortSelect.value;
                let filtered = allFetchedProposals
                    .filter(p => p.title.toLowerCase().includes(filterText))
                    .filter(p => typeFilter === 'all' || p.type === typeFilter);
                filtered.sort((a, b) => {
                    if (sortValue === 'drep-yes-pct-asc') return a.drep_yes_pct - b.drep_yes_pct;
                    return b.drep_yes_pct - a.drep_yes_pct;
                });
                renderProposals(filtered);
            }

            async function fetchAndDisplayProposals() {
                showLoading(proposalsContainer);
                setControlsDisabled(true);
                try {
                    const res = await fetch(proxyUrl(`${networkConfigs[currentNetwork].apiBase}/proposal_list`));
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    const proposals = await res.json();
                    const active = proposals.filter(p => p.ratified_epoch === null && p.enacted_epoch === null && p.dropped_epoch === null && p.expired_epoch === null && p.proposal_type !== 'CommitteeNoConfidence');
                    
                    const summaries = await Promise.all(active.map(p => 
                        fetch(proxyUrl(`${networkConfigs[currentNetwork].apiBase}/proposal_voting_summary?_proposal_id=${p.proposal_id}`))
                        .then(res => res.ok ? res.json() : null)
                        .then(summary => summary && summary[0] ? ({...p, ...summary[0]}) : null)
                        .catch(() => null)
                    ));

                    allFetchedProposals = summaries.filter(Boolean).map(p => ({
                        ...p,
                        type: p.proposal_type,
                        proposal_id: p.proposal_id,
                        title: p.meta_json?.body?.title || 'No Title',
                        abstract: p.meta_json?.body?.abstract || '',
                        motivation: p.meta_json?.body?.motivation || '',
                        rationale: p.meta_json?.body?.rationale || '',
                        drep_yes_pct: parseFloat(p.drep_yes_pct||0),
                        drep_yes_votes_cast: parseInt(p.drep_yes_votes_cast||0),
                        drep_no_votes_cast: parseInt(p.drep_no_votes_cast||0),
                        drep_abstain_votes_cast: parseInt(p.drep_abstain_votes_cast||0)
                    }));
                    dataCache.proposals = true;
                    applyProposalFilters();
                } catch (err) {
                    displayError(proposalsContainer, err.message);
                } finally {
                    setControlsDisabled(false);
                    lastUpdatedElement.textContent = new Date().toLocaleString();
                }
            }

            // --- DRep Directory Logic ---
            function renderDReps(dreps) {
                drepListContainer.innerHTML = '';
                if (!dreps || dreps.length === 0) {
                    drepListContainer.innerHTML = `<div class="text-center p-10 bg-gray-800 rounded-lg"><p class="text-lg">No DReps match the current filters.</p></div>`;
                    return;
                }
                const list = document.createElement('div');
                list.className = 'space-y-4';
                dreps.forEach(drep => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg p-4 flex items-center justify-between';
                    const status = drep.status || 'unknown';
                    const statusColor = status === 'active' ? 'bg-green-600' : (status === 'inactive' ? 'bg-yellow-600' : 'bg-red-600');
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1);

                    card.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="font-mono text-sm text-cyan-400 break-all truncate" title="${drep.drep_id}">${drep.drep_id || 'Unknown ID'}</p>
                        </div>
                        <div class="flex items-center space-x-4 ml-4 flex-shrink-0">
                            <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${statusColor} text-white">${statusText}</span>
                            <button class="view-drep-votes-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg" data-drep-id="${drep.drep_id}">View Votes</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
                drepListContainer.appendChild(list);
            }
            
            function applyDRepFilters() {
                const filterText = drepSearchInput.value.toLowerCase();
                const statusFilter = drepStatusFilter.value;
                let filtered = allFetchedDReps;

                if (statusFilter !== 'all') {
                    filtered = filtered.filter(d => d.status === statusFilter);
                }

                if (filterText) {
                    filtered = filtered.filter(d => d.drep_id.toLowerCase().includes(filterText));
                }
                
                renderDReps(filtered);
            }

            async function fetchAndDisplayDReps() {
                showLoading(drepListContainer);
                setControlsDisabled(true);
                try {
                    const res = await fetch(proxyUrl(`${networkConfigs[currentNetwork].apiBase}/drep_list`));
                    if (!res.ok) throw new Error(`API Error fetching DRep list: ${res.status}`);
                    const allDReps = await res.json();
                    if (!Array.isArray(allDReps)) {
                        throw new Error("Unexpected API response format for DRep list.");
                    }
                    
                    allFetchedDReps = allDReps;
                    dataCache.dreps = true;
                    applyDRepFilters();
                } catch (err) {
                    displayError(drepListContainer, err.message);
                } finally {
                    setControlsDisabled(false);
                }
            }
            
            // --- Modal Logic (Shared) ---
            function renderModalVotes() {
                const showRationale = rationaleFilterCheckbox.checked;
                let votes, config, colors, isHistory;

                if (currentModalVoterType === 'DRepHistory') {
                    votes = showRationale ? voterVoteHistory.filter(v => v.meta_url) : voterVoteHistory;
                    isHistory = true;
                } else {
                    votes = showRationale ? currentModalVotes.filter(v => v.meta_url) : currentModalVotes;
                    isHistory = false;
                }
                
                config = networkConfigs[currentNetwork];
                colors = { Yes: 'text-green-400', No: 'text-red-400', Abstain: 'text-yellow-400' };

                if (votes.length === 0) {
                    modalContent.innerHTML = `<p class="text-gray-400 text-center">No votes found.</p>`;
                    return;
                }

                let header = isHistory ? `<span>Proposal ID</span><span class="text-center">Rationale</span><span class="text-right">Vote</span>` : `<span>${currentModalVoterType} ID</span><span class="text-center">Rationale</span><span class="text-right">Vote</span>`;
                let html = `<div class="grid grid-cols-3 gap-4 text-left font-bold text-gray-400 pb-2 border-b border-gray-600">${header}</div>`;
                
                html += votes.map(v => {
                    const id = isHistory ? v.proposal_id : v.voter_id;
                    const explorerLink = isHistory 
                        ? `${config.govTools}/governance_actions/${id}` 
                        : `${config.govTools}/drep_directory/${id}`;
                    const rationaleButton = v.meta_url ? `<button class="view-rationale-btn text-cyan-400 hover:underline" data-meta-url="${v.meta_url}">ðŸ“„ View</button>` : `<span class="text-gray-600">-</span>`;
                    return `<div class="grid grid-cols-3 gap-4 items-center py-2 border-b border-gray-700 last:border-b-0"><a href="${explorerLink}" target="_blank" rel="noopener noreferrer" class="font-mono text-sm text-cyan-400 hover:underline break-all pr-4">${id}</a><div class="text-center">${rationaleButton}</div><span class="font-bold text-sm text-right ${colors[v.vote] || 'text-gray-400'}">${v.vote}</span></div>`;
                }).join('');
                modalContent.innerHTML = `<div>${html}</div>`;
            }

            async function fetchProposalVotes(proposalId, voterType) {
                votesModal.classList.remove('hidden');
                modalContent.innerHTML = `<div class="flex justify-center p-8"><svg class="animate-spin h-6 w-6 text-white"></svg></div>`;
                currentModalVoterType = voterType;
                modalTitle.textContent = `${voterType} Votes`;
                rationaleFilterCheckbox.checked = false;
                try {
                    const res = await fetch(proxyUrl(`${networkConfigs[currentNetwork].apiBase}/proposal_votes?_proposal_id=${proposalId}`));
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    const allVotes = await res.json();
                    currentModalVotes = allVotes.filter(v => v.voter_role === voterType);
                    modalTitle.textContent = `${voterType} Votes (${currentModalVotes.length} total)`;
                    renderModalVotes();
                } catch (err) {
                    modalContent.innerHTML = `<p class="text-red-400 text-center">${err.message}</p>`;
                }
            }

            async function fetchDRepVotes(drepId) {
                votesModal.classList.remove('hidden');
                modalContent.innerHTML = `<div class="flex justify-center p-8"><svg class="animate-spin h-6 w-6 text-white"></svg></div>`;
                currentModalVoterType = 'DRepHistory';
                modalTitle.textContent = `Vote History for ${drepId.substring(0, 20)}...`;
                rationaleFilterCheckbox.checked = false;
                try {
                    const res = await fetch(proxyUrl(`${networkConfigs[currentNetwork].apiBase}/drep_votes?_drep_id=${drepId}`));
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    voterVoteHistory = await res.json();
                    modalTitle.textContent = `Vote History for ${drepId.substring(0, 20)}... (${voterVoteHistory.length} total)`;
                    renderModalVotes();
                } catch (err) {
                    modalContent.innerHTML = `<p class="text-red-400 text-center">${err.message}</p>`;
                }
            }

            async function fetchAndShowRationale(metaUrl) {
                rationaleModal.classList.remove('hidden');
                rationaleModalContent.innerHTML = `<div class="flex justify-center items-center p-8"><svg class="animate-spin h-6 w-6 text-white"></svg><p class="ml-4">Fetching rationale...</p></div>`;
                
                try {
                    let url;
                    if (metaUrl.startsWith('ipfs://')) {
                        url = `https://ipfs.io/ipfs/${metaUrl.substring(7)}`;
                    } else if (metaUrl.includes('/ipfs/')) {
                        const cid = metaUrl.split('/ipfs/')[1];
                        url = `https://ipfs.io/ipfs/${cid}`;
                    } else {
                        url = metaUrl;
                    }

                    const res = await fetch(proxyUrl(url));
                    if (!res.ok) throw new Error(`Failed to fetch rationale. Status: ${res.status}`);
                    const data = await res.json();
                    
                    const comment = data?.body?.comment;
                    if (comment) {
                        rationaleModalContent.innerHTML = markdownConverter.makeHtml(comment);
                    } else {
                        throw new Error("Rationale 'comment' field not found in metadata.");
                    }
                } catch (err) {
                    rationaleModalContent.innerHTML = `<p class="text-red-400 text-center">${err.message}</p>`;
                }
            }

            // --- AI Summary Logic ---
            async function fetchAndSummarizeProposal(proposalId) {
                aiSummaryModal.classList.remove('hidden');
                aiModalContent.innerHTML = `<div class="flex justify-center items-center p-8"><svg class="animate-spin h-6 w-6 text-white"></svg><p class="ml-4">Generating summary...</p></div>`;
                
                try {
                    if (!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL === 'YOUR_WEB_APP_URL_HERE') {
                        throw new Error("Google Apps Script URL is not configured. Please update the code.");
                    }

                    const proposal = allFetchedProposals.find(p => p.proposal_id === proposalId);
                    if (!proposal) {
                        throw new Error("Could not find proposal details.");
                    }
                    aiModalTitle.textContent = `âœ¨ Summary for: ${proposal.title}`;
                    
                    const proposalText = `Title: ${proposal.title}\n\nAbstract: ${proposal.abstract}\n\nMotivation: ${proposal.motivation}\n\nRationale: ${proposal.rationale}`;
                    if (proposalText.trim().length < 50) {
                        aiModalContent.innerHTML = `<p class="text-yellow-400">Not enough metadata to generate a summary.</p>`;
                        return;
                    }

                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ text: proposalText }),
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', // Required for Apps Script
                        },
                    });
                    
                    if (!response.ok) {
                         throw new Error(`Request to proxy failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.summary) {
                        aiModalContent.innerHTML = markdownConverter.makeHtml(result.summary);
                    } else if (result.error) {
                        throw new Error(result.error);
                    }
                    else {
                        throw new Error("No summary was returned from the function.");
                    }
                } catch (err) {
                    aiModalContent.innerHTML = `<p class="text-red-400">Failed to generate summary: ${err.message}</p>`;
                }
            }

            // --- Event Listeners ---
            navProposals.addEventListener('click', () => showPage('proposals'));
            navDRepDirectory.addEventListener('click', () => showPage('dreps'));
            
            networkSelect.addEventListener('change', (e) => {
                currentNetwork = e.target.value;
                networkNameSpan.textContent = networkConfigs[currentNetwork].name;
                dataCache = { proposals: false, dreps: false }; // Invalidate cache
                const currentPage = document.querySelector('.nav-button[aria-selected="true"]').id.replace('nav-', '').replace('-directory', '');
                showPage(currentPage);
            });

            // Proposal page listeners
            [searchInput, sortSelect, typeFilterSelect].forEach(el => el.addEventListener('change', applyProposalFilters));
            searchInput.addEventListener('input', applyProposalFilters);
            proposalsContainer.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.view-votes-btn');
                const summaryBtn = e.target.closest('.summarize-btn');
                if (viewBtn) fetchProposalVotes(viewBtn.dataset.proposalId, viewBtn.dataset.voterType);
                if (summaryBtn) fetchAndSummarizeProposal(summaryBtn.dataset.proposalId);
            });

            // DRep page listeners
            drepSearchInput.addEventListener('input', applyDRepFilters);
            drepStatusFilter.addEventListener('change', applyDRepFilters);
            drepListContainer.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.view-drep-votes-btn');
                if (viewBtn) fetchDRepVotes(viewBtn.dataset.drepId);
            });
            
            // Modal listeners
            rationaleFilterCheckbox.addEventListener('change', renderModalVotes);
            modalContent.addEventListener('click', (e) => {
                const rationaleBtn = e.target.closest('.view-rationale-btn');
                if (rationaleBtn) {
                    fetchAndShowRationale(rationaleBtn.dataset.metaUrl);
                }
            });
            modalCloseBtn.addEventListener('click', () => votesModal.classList.add('hidden'));
            votesModal.addEventListener('click', (e) => { if (e.target === votesModal) votesModal.classList.add('hidden'); });
            aiModalCloseBtn.addEventListener('click', () => aiSummaryModal.classList.add('hidden'));
            aiModalCloseBtn.addEventListener('click', (e) => { if (e.target === aiSummaryModal) aiSummaryModal.classList.add('hidden'); });
            rationaleModalCloseBtn.addEventListener('click', () => rationaleModal.classList.add('hidden'));
            rationaleModal.addEventListener('click', (e) => { if (e.target === rationaleModal) rationaleModal.classList.add('hidden'); });

            // --- Initial Load ---
            showPage('proposals');
        });
    </script>
</body>
</html>
